<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Data</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
</head>

<body class="container mt-4">
    <h2 class="mb-3">Upload Data</h2>
    <form id="uploadForm" class="mb-4">
        <div class="mb-3">
            <input type="text" id="nama" class="form-control" placeholder="Nama" required>
        </div>
        <div class="mb-3">
            <input type="text" id="alamat" class="form-control" placeholder="Alamat" required>
        </div>
        <div class="mb-3">
            <input type="file" id="fileInput" class="form-control" accept="image/*,video/*" required>
        </div>
        <button type="submit" class="btn btn-primary">Upload</button>
    </form>

    <h2>Data yang Telah Diupload</h2>
    <table id="dataTable" class="table table-bordered display">
        <thead class="table-dark">
            <tr>
                <th>Nama</th>
                <th>Alamat</th>
                <th>File</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#dataTable').DataTable();
        });

        const token = "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";
        const repo = "jejakprogrammer/file_data";
        const dbFile = "db.json";
        const branch = "main";

        document.getElementById("uploadForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            const nama = document.getElementById("nama").value;
            const alamat = document.getElementById("alamat").value;
            const file = document.getElementById("fileInput").files[0];

            if (!file) {
                alert("Pilih file terlebih dahulu!");
                return;
            }

            const uniqueFileName = generateUniqueFileName(file.name);
            const filePath = `uploads/${uniqueFileName}`;
            const fileContent = await readFileAsBase64(file);

            const uploadResponse = await uploadToGitHub(filePath, fileContent);
            if (!uploadResponse.content) {
                alert("Gagal mengunggah file.");
                return;
            }

            let {
                data: dbData,
                sha
            } = await fetchGitHubFile(dbFile);
            if (!dbData || !Array.isArray(dbData)) dbData = [];

            dbData.push({
                nama,
                alamat,
                file: uniqueFileName
            });

            const dbResponse = await saveToGitHub(dbFile, dbData, sha);
            if (dbResponse.content) {
                alert("Data berhasil disimpan!");
                document.getElementById("uploadForm").reset();
                loadData();
            } else {
                alert("Gagal menyimpan data.");
            }
        });

        function generateUniqueFileName(originalName) {
            const timestamp = Date.now();
            const randomString = Math.random().toString(36).substring(2, 10);
            const extension = originalName.split('.').pop();
            return `${timestamp}_${randomString}.${extension}`;
        }

        async function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(",")[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function uploadToGitHub(filePath, content) {
            return fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: `Upload ${filePath}`,
                    content: content,
                    branch: branch
                })
            }).then(res => res.json());
        }

        async function fetchGitHubFile(filePath) {
            const response = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                headers: {
                    "Authorization": `token ${token}`
                }
            });
            if (!response.ok) return {
                data: [],
                sha: null
            };
            const data = await response.json();
            return {
                data: JSON.parse(atob(data.content)),
                sha: data.sha
            };
        }

        async function saveToGitHub(filePath, content, sha) {
            return fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: `Update ${filePath}`,
                    content: btoa(JSON.stringify(content, null, 2)),
                    sha: sha,
                    branch: branch
                })
            }).then(res => res.json());
        }

        async function loadData() {
            const {
                data
            } = await fetchGitHubFile(dbFile);
            const table = $('#dataTable').DataTable();
            table.clear();
            data.forEach(item => {
                const fileUrl = `https://raw.githubusercontent.com/${repo}/${branch}/uploads/${item.file}`;
                const fileType = item.file.split(".").pop();
                const fileLink = fileType.startsWith("mp4") ?
                    `<a href="${fileUrl}" target="_blank" class="btn btn-primary">Lihat Video</a>` :
                    `<a href="${fileUrl}" target="_blank">${fileUrl}</a>`;
                table.row.add([item.nama, item.alamat, fileLink]).draw();
            });
        }

        loadData();
    </script>
</body>

</html>